# Next.js API Route でリクエストパラメータを受け取り、DB 操作・結果返却までの流れ

## 📅 学習日時

2025 年 8 月 4 日

## ✅ 結論

Next.js の API Route では、リクエストパラメータ（クエリやボディ）から情報を受け取り、値のバリデーションを行い、DB 操作（取得・保存）を実施し、結果を JSON で返却する流れが基本となる。

## 🧠 詳細

### 1. リクエストパラメータの受け取り

- GET の場合: `new URL(request.url).searchParams.get("param")` でクエリパラメータを取得
- POST の場合: `await request.json()` でボディから値を取得

### 2. バリデーション

- 必須パラメータの有無や型・形式をチェック
- 不正な場合は `NextResponse.json({ error: ... }, { status: 400 })` でエラー返却

### 3. DB 操作

- Prisma Client を使い、findMany（取得）や create（保存）などの操作を実施
- 取得時は条件（where）や並び順（orderBy）を指定
- 保存時は値を整形し、必要に応じて型変換（例: 日付文字列 →Date 型）

### 4. 結果の返却

- 正常時は `NextResponse.json(結果)` で返却
- エラー時は内容に応じてステータスコード・メッセージを分岐

---

#### 実装例（GET）

```typescript
const { searchParams } = new URL(request.url);
const month = searchParams.get("month");
if (!month || !/^\d{4}-\d{2}$/.test(month)) {
  return NextResponse.json(
    { error: "month (YYYY-MM) is required" },
    { status: 400 }
  );
}
// ...DB操作・返却...
```

#### 実装例（POST）

```typescript
const { videoId, watchedAt } = await request.json();
if (!videoId || typeof videoId !== "string") {
  return NextResponse.json({ error: "videoId is required" }, { status: 400 });
}
// ...DB操作・返却...
```

---

### ポイント

- パラメータ取得 → バリデーション →DB 操作 → 結果返却の流れを明確に分ける
- バリデーションは必ず最初に行い、エラー時は早期 return
- Prisma の型変換（Date 型など）やエラー分岐（UNIQUE 制約違反など）も明示
- コメントで各ステップの意図を明確化

---

#### 参考: 学習メモガイド

- ファイル命名: `2025-08-04_APIパラメータ受け取りとDB操作.md`
- 分類: `implementations/`（具体的なコード実装・API 設計）
