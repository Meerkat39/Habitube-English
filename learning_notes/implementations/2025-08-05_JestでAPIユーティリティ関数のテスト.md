# Jest で API ユーティリティ関数のテストを書く・実行する

## 📅 学習日時

2025 年 8 月 5 日

## ✅ 結論

Jest を使うことで、API ユーティリティ関数（fetchWatchedVideoList）の正常系・異常系の挙動をモックで再現し、型安全かつ分かりやすいテストが書ける。テストは全てパスし、実装の信頼性が高まった。

## 🧠 詳細

### テストのポイント

- 実際の API 通信は行わず、fetch をモック（偽物）に置き換えて任意の値を返す
- 正常系（データ取得成功）と異常系（API 失敗 → エラー throw）を分けて検証
- TypeScript で型安全にグローバル fetch を拡張
- テスト前に beforeEach で毎回 fetch を初期化

### テストコード例

```typescript
import { fetchWatchedVideoList } from "../watchedVideoApi";
// fetchのグローバルモック（型安全に拡張）
const globalWithFetch = global as typeof global & { fetch: jest.Mock };

describe("fetchWatchedVideoList", () => {
  // 各テスト前にfetchをモック（偽物の関数）に置き換える
  beforeEach(() => {
    globalWithFetch.fetch = jest.fn();
  });

  it("正常に履歴データを取得できる", async () => {
    // モック: APIが正常にデータを返す場合の挙動を再現
    const mockData = [
      { id: 1, videoId: "abc", watchedAt: "2025-08-01T00:00:00Z" },
    ];
    globalWithFetch.fetch.mockResolvedValue({
      ok: true, // fetchの返り値が正常
      json: async () => mockData, // .json()でmockDataを返す
    });
    // 関数を呼び出し、mockDataが返ることを検証
    const result = await fetchWatchedVideoList("2025-08");
    expect(result).toEqual(mockData);
  });

  it("API失敗時はエラーをthrowする", async () => {
    // モック: APIが失敗（ok: false）した場合の挙動を再現
    globalWithFetch.fetch.mockResolvedValue({ ok: false });
    // 関数を呼び出し、エラーがthrowされることを検証
    await expect(fetchWatchedVideoList("2025-08")).rejects.toThrow(
      "Failed to fetch watched video list"
    );
  });
});
```

### テスト実行結果

- 2 ケースともパス（Jest の出力で確認）
- 実装の信頼性・安全性が担保される

---

#### 分類: implementations（具体的なコード実装・テスト設計）

ファイル名: `2025-08-05_JestでAPIユーティリティ関数のテスト.md`
